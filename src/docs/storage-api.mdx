# Storage API Reference

## Table of Contents

## Overview

This reference guide covers all storage-related APIs, functions, and types available in our Tauri application. Use this as a comprehensive reference for implementing storage functionality.

## Tauri Commands

### Database Commands

#### `initialize_database`

Initializes the SQLite database and creates necessary tables.

```typescript
import { invoke } from '@tauri-apps/api/core'

const result = await invoke<string>('initialize_database')
console.log(result) // "Database initialized successfully"
```

**Returns:** `Promise<string>`

**Errors:**

- Database file creation failure
- Permission denied
- Invalid app data directory

---

#### `check_database_health`

Checks the current health status of the database connection.

```typescript
interface DatabaseHealth {
    status: 'healthy' | 'error' | 'disconnected' | 'checking'
    message: string
    last_checked: string
    response_time?: number
}

const health = await invoke<DatabaseHealth>('check_database_health')
```

**Returns:** `Promise<DatabaseHealth>`

**Example Response:**

```json
{
    "status": "healthy",
    "message": "Database is healthy (5ms)",
    "last_checked": "2024-01-15T10:30:00Z",
    "response_time": 5
}
```

---

#### `execute_database_query`

Executes a SQL query against the database.

```typescript
interface QueryResult {
    status: 'success' | 'error'
    message: string
    result?: string
    response_time: number
    last_executed: string
}

const result = await invoke<QueryResult>('execute_database_query', {
    query: 'SELECT * FROM users'
})
```

**Parameters:**

- `query: string` - The SQL query to execute

**Returns:** `Promise<QueryResult>`

**Example Response:**

```json
{
    "status": "success",
    "message": "Query executed successfully (12ms)",
    "result": "Rows affected: 3",
    "response_time": 12,
    "last_executed": "2024-01-15T10:30:00Z"
}
```

## React Hooks

### `useDatabaseHealth`

Custom hook for monitoring database health with automatic polling.

```typescript
interface UseDatabaseHealthOptions {
    interval?: number // Polling interval in ms (default: 30000)
    immediate?: boolean // Check immediately on mount (default: true)
}

interface UseDatabaseHealthReturn {
    health: DatabaseHealth
    isLoading: boolean
    checkHealth: () => Promise<void>
    refresh: () => Promise<void>
}

const { health, isLoading, refresh } = useDatabaseHealth({
    interval: 60000, // Check every minute
    immediate: true
})
```

**Usage Example:**

```typescript
function DatabaseStatus() {
  const { health, isLoading, refresh } = useDatabaseHealth()

  return (
    <div>
      <span className={`status-${health.status}`}>
        {health.status.toUpperCase()}
      </span>
      <p>{health.message}</p>
      <button onClick={refresh} disabled={isLoading}>
        Refresh
      </button>
    </div>
  )
}
```

## File System APIs

### Path Resolution

#### `appDataDir()`

Gets the application data directory path.

```typescript
import { appDataDir } from '@tauri-apps/api/path'

const dataDir = await appDataDir()
// Linux: /home/user/.local/share/com.remcostoeten.notr
// macOS: /Users/user/Library/Application Support/com.remcostoeten.notr
// Windows: C:\Users\user\AppData\Roaming\com.remcostoeten.notr
```

#### `join()`

Joins path segments safely.

```typescript
import { join } from '@tauri-apps/api/path'

const configPath = await join(await appDataDir(), 'config', 'settings.json')
const snippetPath = await join(await appDataDir(), 'snippets', 'javascript')
```

### File Operations

#### `readTextFile()`

Reads a text file from the file system.

```typescript
import { readTextFile } from '@tauri-apps/api/fs'

try {
    const content = await readTextFile(filePath)
    const data = JSON.parse(content)
} catch (error) {
    console.error('Failed to read file:', error)
}
```

#### `writeTextFile()`

Writes text content to a file.

```typescript
import { writeTextFile } from '@tauri-apps/api/fs'

const data = { name: 'John', age: 30 }
await writeTextFile(filePath, JSON.stringify(data, null, 2))
```

#### `createDir()`

Creates a directory (and parent directories if needed).

```typescript
import { createDir } from '@tauri-apps/api/fs'

await createDir(directoryPath, { recursive: true })
```

#### `exists()`

Checks if a file or directory exists.

```typescript
import { exists } from '@tauri-apps/api/fs'

if (await exists(filePath)) {
    console.log('File exists')
}
```

## Type Definitions

### Core Types

```typescript
// Database health status
type DatabaseHealthStatus = 'healthy' | 'error' | 'disconnected' | 'checking'

// Database health information
interface DatabaseHealth {
    status: DatabaseHealthStatus
    message: string
    lastChecked: Date
    responseTime?: number
}

// Query execution result
interface QueryResult {
    status: 'success' | 'error'
    message: string
    result?: string
    response_time: number
    last_executed: string
}

// Application configuration
interface AppConfig {
    theme: 'light' | 'dark' | 'system'
    autoSave: boolean
    fontSize: number
    language: string
}

// User data structure
interface User {
    id: number
    name: string
    snippets_path: string
    created_at: number
}

// Code snippet structure
interface Snippet {
    id: number
    title: string
    content: string
    file_path: string
    created_at: number
    updated_at: number
}
```

### Storage Utilities

```typescript
// Configuration manager class
class ConfigManager<T> {
    constructor(private configPath: string) {}

    async load(): Promise<T | null>
    async save(data: T): Promise<void>
    async exists(): Promise<boolean>
    async delete(): Promise<void>
}

// File system utilities
interface FileSystemUtils {
    ensureDir(path: string): Promise<void>
    copyFile(src: string, dest: string): Promise<void>
    moveFile(src: string, dest: string): Promise<void>
    deleteFile(path: string): Promise<void>
    listFiles(dir: string): Promise<string[]>
}
```

## Error Handling

### Error Types

```typescript
// Database errors
class DatabaseError extends Error {
    constructor(
        message: string,
        public code: string,
        public query?: string
    ) {
        super(message)
        this.name = 'DatabaseError'
    }
}

// File system errors
class FileSystemError extends Error {
    constructor(
        message: string,
        public path: string,
        public operation: string
    ) {
        super(message)
        this.name = 'FileSystemError'
    }
}

// Configuration errors
class ConfigError extends Error {
    constructor(
        message: string,
        public configPath: string
    ) {
        super(message)
        this.name = 'ConfigError'
    }
}
```

### Error Handling Patterns

```typescript
// Safe database operation
async function safeDatabaseOperation<T>(
    operation: () => Promise<T>
): Promise<T | null> {
    try {
        return await operation()
    } catch (error) {
        if (error instanceof DatabaseError) {
            console.error('Database error:', error.message, error.code)
        } else {
            console.error('Unexpected error:', error)
        }
        return null
    }
}

// Safe file operation
async function safeFileOperation<T>(
    operation: () => Promise<T>
): Promise<T | null> {
    try {
        return await operation()
    } catch (error) {
        if (error instanceof FileSystemError) {
            console.error('File system error:', error.message, error.path)
        } else {
            console.error('Unexpected error:', error)
        }
        return null
    }
}
```

## Configuration Examples

### Application Settings

```typescript
// Load application settings
const configManager = new ConfigManager<AppConfig>(
    await join(await appDataDir(), 'config', 'settings.json')
)

const settings = (await configManager.load()) ?? {
    theme: 'system',
    autoSave: true,
    fontSize: 14,
    language: 'en'
}

// Save updated settings
await configManager.save({
    ...settings,
    theme: 'dark',
    fontSize: 16
})
```

### User Preferences

```typescript
interface UserPreferences {
    sidebarCollapsed: boolean
    editorWordWrap: boolean
    showLineNumbers: boolean
    tabSize: number
}

const prefsManager = new ConfigManager<UserPreferences>(
    await join(await appDataDir(), 'config', 'preferences.json')
)

const prefs = (await prefsManager.load()) ?? {
    sidebarCollapsed: false,
    editorWordWrap: true,
    showLineNumbers: true,
    tabSize: 2
}
```

## Performance Considerations

### Caching Strategies

```typescript
// Cache frequently accessed data
class DataCache<T> {
    private cache = new Map<string, { data: T; timestamp: number }>()
    private ttl: number

    constructor(ttlMs: number = 300000) {
        // 5 minutes default
        this.ttl = ttlMs
    }

    set(key: string, data: T): void {
        this.cache.set(key, { data, timestamp: Date.now() })
    }

    get(key: string): T | null {
        const entry = this.cache.get(key)
        if (!entry) return null

        if (Date.now() - entry.timestamp > this.ttl) {
            this.cache.delete(key)
            return null
        }

        return entry.data
    }

    clear(): void {
        this.cache.clear()
    }
}
```

### Batch Operations

```typescript
// Batch database operations for better performance
async function batchInsertSnippets(snippets: Omit<Snippet, 'id'>[]) {
    const queries = snippets.map(
        (snippet) =>
            `INSERT INTO snippets (title, content, file_path, created_at, updated_at) 
     VALUES ('${snippet.title}', '${snippet.content}', '${snippet.file_path}', 
             ${snippet.created_at}, ${snippet.updated_at})`
    )

    // Execute in transaction for atomicity
    const transactionQueries = ['BEGIN TRANSACTION', ...queries, 'COMMIT']

    for (const query of transactionQueries) {
        const result = await invoke('execute_database_query', { query })
        if (result.status === 'error') {
            await invoke('execute_database_query', { query: 'ROLLBACK' })
            throw new Error(`Batch insert failed: ${result.message}`)
        }
    }
}
```

## Migration Utilities

```typescript
// Database migration system
interface Migration {
    version: number
    description: string
    up: string[]
    down: string[]
}

const migrations: Migration[] = [
    {
        version: 1,
        description: 'Create initial tables',
        up: [
            `CREATE TABLE users (
        id INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        created_at INTEGER NOT NULL
      )`,
            `CREATE TABLE snippets (
        id INTEGER PRIMARY KEY,
        title TEXT NOT NULL,
        content TEXT NOT NULL,
        user_id INTEGER,
        FOREIGN KEY (user_id) REFERENCES users (id)
      )`
        ],
        down: ['DROP TABLE snippets', 'DROP TABLE users']
    }
]

async function runMigrations() {
    for (const migration of migrations) {
        console.log(
            `Running migration ${migration.version}: ${migration.description}`
        )

        for (const query of migration.up) {
            await invoke('execute_database_query', { query })
        }
    }
}
```
